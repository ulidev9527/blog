# 快速搭建一个容器化环境的服务器

## 提示
阅读本文需要有一些服务器部署相关经验  
`$ xxxx` 开头的表示一条命令，复制 `$` 后面内容粘贴到控制台即可。  
`docker` 不自带分布式存储和共享存储功能，需要多节点共享文件需自行实现。  
`filebrowser` 登录账号是 `admin`, 密码需要在`docker`容器的日志中查看  
`grafana` 默认账号/密码：`admin`/`admin`  
**!! 注意，`prometheus.yaml/cadvisor/volumes` 配置中的 `/var/run/docker/containerd/containerd.sock:/run/containerd/containerd.sock:ro` 路径需要映射你系统所在的路径**  


## 目标
准备一个开箱即用的容器化服务环境，包含文件管理、容器管理、日志查看、服务器监控、容器监控。

## 前期准备：
- 准备一个服务器
- 涉及到主机端口号时，根据情况换成自己的端口，云服务区注意需要安全组/防火墙放行
- 在服务上安装 `docker`
- 学一些 `docker` 命令
- 启动`docker`集群 `$ docker swarm init`

## 核心内容
- [Portainer](https://www.portainer.io/) 容器管理 
- [nginx-proxy-manager](https://nginxproxymanager.com/) 代理管理
- [Grafana/Grafana](https://grafana.com/docs/grafana) 仪表板
- [Grafana/Alloy](https://grafana.com/docs/alloy) 日志收集
- [Grafana/Loki](https://grafana.com/docs/loki) 日志存储
- [prom/prometheus](https://prometheus.io/) 指标/监控
  - [cadvisor] 容器监控
- [Gitea](gitea.com) 版本管理 
    - 这里主要用于管理 `docker-compose`文件版本
    - 你也可以使用 `github`
    - 如果使用外部仓库，文中 `gitea` 相关内容可以忽略
    - 建议使用外部仓库
- [Filebrowser](https://filebrowser.org) 文件管理

## 准备镜像
***此处镜像版本获取于`2026-01-20`，会有新的版本，实际使用时自行升级***

- portainer/agent:2.33.6
- portainer/portainer-ce:2.33.6
- jc21/nginx-proxy-manager:2.13.6
- grafana/grafana:12.3.1
- grafana/loki:3.6.3
- grafana/alloy:v1.12.2
- prom/prometheus:v3.9.1
- gitea/gitea:1.25.3
- filebrowser/filebrowser:v2.55.0
- ghcr.io/google/cadvisor:0.56.2

## 开始搭建

### 准备所有文件夹
```shell
mkdir -p /data/filebrowser-config /data/filebrowser-database
mkdir -p /data/gitea-data /data/gitea-conf # 外部 git 仓库可以不用
mkdir -p /data/grafana-data 
mkdir -p /data/grafana-loki-data
mkdir -p /data/grafana-alloy-data /data/grafana-alloy-config
mkdir -p /data/nginx-proxy-manager-www /data/nginx-proxy-manager-data /data/nginx-proxy-manager-data/logs /data/nginx-proxy-manager-letsencrypt
mkdir -p /data/portainer-data 
mkdir -p /data/prometheus-data

```

### `portainer` 安装
- [图片示例](#portainer)
- 启动
  - 有外部仓库 `$ docker run -p 9000:9000 --name portainer_tmp --restart=unless-stopped -v /var/run/docker.sock:/var/run/docker.sock -v /data/portainer-data:/data -d portainer/portainer-ce:2.33.6`
  - 本文自建仓库 `$ docker run -p 9000:9000 --name portainer_tmp --restart=unless-stopped -v /var/run/docker.sock:/var/run/docker.sock -v /data/portainer-data:/data --add-host=gitea.basic.local:YOUR_IP -d portainer/portainer-ce:2.33.6`
    - `gitea.basic.local` 是自定义域名，可以自己修改，同步修改 [gitea.yaml](../files/first-create-docker-server/gitea.yaml) 中的 `gitea.basic.local`
    - 将 `YOUR_IP` 修改为服务器实际IP
- 浏览器访问：http://IP:9000
- 创建账号密码,然后进入 `portainer`
- 创建一个`docker`网络
  - 进入网络管理面板，点击 **左上 Home - 选择中的 local - 左边菜单栏Networks**
  - 点击右上 **Add Network** 按钮
  - 配置网络
    - Name: `basicnet`
    - Driver: `overlay`
    - Enable manual container attachment: **勾选**
  - 点击最下面 **create the network**

### `gitea` 安装，使用外部仓库可以跳过
`gitea` 主要用于 `docker-compose` 版本管理，如果有其它仓库可以忽略本步骤。  

- 启动
  - `$ docker run -p 3000:3000 --name gitea_tmp --restart=unless-stopped -v /data/gitea-data:/data -d gitea/gitea:1.25.3`
- 访问 http://IP:3000
- 配置完成后进入`gitea`
- 创建仓库：
  - 点击右上角 **+** 图标，选择 **创建仓库**
  - 名称：`docker-compose`
  - 可以勾选 **将仓库设置为私有** 选项，增加访问权限
  - 勾选 **初始化仓库(添加.gitXXXXXX)** 选项
  - 点击 **创建仓库**
- 私有仓库先添加协作者
  - **此步骤注意用于仓库安全，根据情况添加**
  - 创建部署用的账户
    - 点击右上角 **头像 - 管理后台**
    - 点击展开 **管理设置/身份及认证/账户管理**
    - 点击右上角 **创建新账户**
      - 取消 **要求用户更改密码** 选项
  - 添加协作者
    - 进入刚才创建的仓库
    - 点击右上角 **设置 - 协作者**
    - 输入刚才创建用用户，然后点击 **增加协作者**
    - 删除左边**下拉框**, 选择 **可读权限**

## 准备相关资源
- 拉取 `docker-compose` 仓库到本地
- 将 [资源文件](../files/first-create-docker-server/) 中的所有 `.yaml` 文件上传到仓库传到 `git`
  - **!! 注意，`prometheus.yaml/cadvisor/volumes` 配置中的 `/var/run/docker/containerd/containerd.sock:/run/containerd/containerd.sock:ro` 路径需要映射你系统所在的路径**
- 保证服务器已经执行 `$ docker swarm init`
- 将 [config](../files/first-create-docker-server/config) 所有配置文件上传到服务器的 `/data` 文件夹中
  - 如果服务器安装 `git`，可以直接克隆 `docker-compose` 仓库到服务器，然后将 `docker-compose/config` 文件夹下面的所有内容复制到 `/data` 即可。
  - TIPS: **配置文件最终结构是: `/data/XXX.yaml`, 不是 `/data/config/XXX.yaml`**
## 启动相关容器
- 访问：`http://IP:9000` 进入 `Portainer` 界面
- 按下方[图例](#portainer图片示例), 点击 **Add stack** 按钮
- 配置`Stack`
  - Name: `basic`
  - Build method: `Repository` 
  - Authentication:
    - 如果仓库有授权，则添加授权，没有则忽略
  - Repository URL: `http://gitea.basic.local:3000/admin/docker-compose.git`
    - 这里填写你的 `docker-compose` 文件的仓库
  - Compose path: `portainer.yaml`
  - Additional paths: 
    - `docker swarm` 不支持合并 `yaml` 文件，所以只有手动添加全部基础的 `yaml` 文件
    - 点击 `Add file` 按钮， 把下面文件名添加到里面，每个文件都要单独添加
      - `filebrowser.yaml` 
      - `gitea.yaml`
      - `grafana-alloy.yaml`
      - `grafana-loki.yaml`
      - `grafana.yaml`
      - `nginx-proxy-manager.yaml`
      - `prometheus.yaml`
  - Environment variables
    - 配置环境变量
    - `MASTER_HOSTNAME` 你的主机名, linux 执行 `hostname` 即可查看
    - `PORTAINER_AGENT_SECRET` `portaienr` 认证密钥，只有密钥相同才能绑定 `agent`
- 点击 `Deploy the stack` 按钮进行部署，然后等待部署完成
- 部署完成后，访问: `http://IP:81` 即可进入代理配置
  - 按照 [图片示例](#nginx-proxy-manager-图片示例) 配置账号
  - 安装 [图片示例](#nginx-proxy-manager-图片示例) 配置代理
    - Domain Names: `填写你的域名`
    - Scheme: 如果是公共域名，这里可以填写 `https`, 内网域名选 `http`
    - Forward Hostname / IP: 填写 `docker` 服务名称
    - Forward Port: 填写 `docker` 服务端口
  - 配置 `portainer` / `gitea` / `gnixn-proxy-manager` / `filebrowser` / `grafana` 的代理
    - DomainNames(域名)填写自己对应
    - DomainNames: `portainer.basic.local` 
      - Forward Hostname / IP: `portainer` 
      - Forward Port: `9000`
      - Websockets Support: 勾选, 不勾选无法开启网页控制台
    - DomainNames: `nginxproxymanager.basic.local`  IP: `nginx-proxy-manager` Port: `81`
    - DomainNames: `gitea.basic.local`  IP: `gitea` Port: `3000`
    - DomainNames: `filebrowser.basic.local` IP: `filebrowser` Port: `80`
    - DomainNames: `grafana.basic.local` IP: `grafana` Port: `3000`
- 代理配置完成后，服务器则停止 `portainer_tmp` 和 `gitea_tmp`，等待容器自动启动后
  - `$ docker stop portainer_tmp gitea_tmp`
- 代理的内网域名需要在你电脑 `hosts` 文件中添加固定`dns`解析  
- 此时访问你配置的域名
- `nginx-proxy-manager.yaml` 中的 `81` 端口可以关闭，使用代理访问。

## 配置监控
- 进入 `grafana.basic.local`(域名修改为你的配置)
  - 首次进入输入账号/密码 `admin`/`admin`
- 按 [图片示例](#grafana-图片示例) 配置数据源
  - 点击左边菜单栏：`Home` > `Connections` > `Data sources` > `Add new data source`
    - 搜索 `loki`
      - URL: `http://grafana-loki:3100`
    - 搜索 `prometheus`
      - Prometheus server URL : `http://prometheus:9090`
    - 点击页面最下面： `Save & test` 按钮，图片示例中显示则表示成功
- 按 [图片示例](#grafana-图片示例) 即可查看日志/监控
- 你还可以去 [https://grafana.com/grafana/dashboards/](https://grafana.com/grafana/dashboards/) 找你喜欢的监控面板
  - 推荐：
    - https://grafana.com/grafana/dashboards/1860-node-exporter-full/
    - https://grafana.com/grafana/dashboards/11074-node-exporter-for-prometheus-dashboard-en-v20201010/

## 附录
### Portainer图片示例
![](../files/first-create-docker-server/img/1.png)
![](../files/first-create-docker-server/img/2.png)
![](../files/first-create-docker-server/img/3.png)
![](../files/first-create-docker-server/img/9.png)
![](../files/first-create-docker-server/img/8.png)
![](../files/first-create-docker-server/img/10.png)
### Gitea图片示例
![](../files/first-create-docker-server/img/4.png)
![](../files/first-create-docker-server/img/5.png)
![](../files/first-create-docker-server/img/6.png)
![](../files/first-create-docker-server/img/7.png)
### Nginx-proxy-manager 图片示例
![](../files/first-create-docker-server/img/11.png)
![](../files/first-create-docker-server/img/12.png)
![](../files/first-create-docker-server/img/13.png)
![](../files/first-create-docker-server/img/14.png)
### grafana 图片示例
![](../files/first-create-docker-server/img/15.png)
![](../files/first-create-docker-server/img/16.png)
![](../files/first-create-docker-server/img/17.png)
![](../files/first-create-docker-server/img/18.png)